<!-- Leak Detection Component -->
<div class="component leak-detection-component">
    <div class="component-header">
        <h3><i class="fas fa-exclamation-triangle"></i> Leak Detection & Response System</h3>
        <div class="component-actions">
            <button class="action-btn primary" onclick="initiateLeakScan()">
                <i class="fas fa-search"></i> Scan Now
            </button>
            <button class="action-btn secondary" onclick="viewLeakHistory()">
                <i class="fas fa-history"></i> History
            </button>
        </div>
    </div>
    
    <div class="leak-status-container">
        <div class="status-overview">
            <div class="status-card active-leaks">
                <div class="status-icon critical">
                    <i class="fas fa-faucet-drip"></i>
                </div>
                <div class="status-content">
                    <h4>Active Leaks</h4>
                    <div class="status-value">
                        <span class="count critical">{{ leaks|length }}</span>
                        <span class="unit"> detected</span>
                    </div>
                </div>
            </div>
            
            <div class="status-card leak-history">
                <div class="status-icon warning">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="status-content">
                    <h4>24h History</h4>
                    <div class="status-value">
                        <span class="count">{{ leaks|length * 3 }}</span>
                        <span class="unit"> incidents</span>
                    </div>
                </div>
            </div>
            
            <div class="status-card response-time">
                <div class="status-icon good">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="status-content">
                    <h4>Avg Response</h4>
                    <div class="status-value">
                        <span class="count">12</span>
                        <span class="unit"> minutes</span>
                    </div>
                </div>
            </div>
            
            <div class="status-card water-saved">
                <div class="status-icon info">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="status-content">
                    <h4>Water Saved</h4>
                    <div class="status-value">
                        <span class="count">2,450</span>
                        <span class="unit"> liters</span>
                    </div>
                </div>
            </div>
        </div>
        
        {% if leaks %}
        <div class="active-leaks-alert">
            <div class="alert-header critical">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="alert-content">
                    <h4>ACTIVE LEAKS DETECTED</h4>
                    <p>Immediate action required to prevent water loss and damage</p>
                </div>
                <div class="alert-actions">
                    <button class="action-btn danger" onclick="emergencyProtocol()">
                        <i class="fas fa-siren-on"></i> Emergency Protocol
                    </button>
                </div>
            </div>
            
            <div class="leaks-list">
                {% for pipe_name, status in leaks.items() %}
                <div class="leak-item critical">
                    <div class="leak-info">
                        <div class="leak-header">
                            <div class="leak-icon">
                                <i class="fas fa-faucet-drip"></i>
                            </div>
                            <div class="leak-details">
                                <h5>{{ pipe_name }}</h5>
                                <p class="leak-severity">CRITICAL - Active Water Loss</p>
                            </div>
                        </div>
                        
                        <div class="leak-metrics">
                            <div class="metric">
                                <span class="metric-label">Flow Loss:</span>
                                <span class="metric-value critical">2.5 L/min</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Pressure Drop:</span>
                                <span class="metric-value">0.8 bar</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Duration:</span>
                                <span class="metric-value">~15 minutes</span>
                            </div>
                        </div>
                        
                        <div class="leak-location">
                            <p><i class="fas fa-map-marker-alt"></i> Estimated location: Downstream section</p>
                        </div>
                    </div>
                    
                    <div class="leak-actions">
                        <button class="action-btn danger small" onclick="isolateSection('{{ pipe_name }}')">
                            <i class="fas fa-ban"></i> Isolate
                        </button>
                        <button class="action-btn secondary small" onclick="dispatchTeam('{{ pipe_name }}')">
                            <i class="fas fa-user-hard-hat"></i> Dispatch
                        </button>
                        <button class="action-btn small" onclick="leakDetails('{{ pipe_name }}')">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="no-leaks-alert">
            <div class="alert-header good">
                <div class="alert-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="alert-content">
                    <h4>SYSTEM INTEGRITY VERIFIED</h4>
                    <p>No active leaks detected in the water network</p>
                </div>
            </div>
            
            <div class="integrity-check">
                <div class="check-item">
                    <i class="fas fa-check-circle good"></i>
                    <span>All pipe sections pressurized</span>
                </div>
                <div class="check-item">
                    <i class="fas fa-check-circle good"></i>
                    <span>Flow rates within normal range</span>
                </div>
                <div class="check-item">
                    <i class="fas fa-check-circle good"></i>
                    <span>Pressure sensors operational</span>
                </div>
                <div class="check-item">
                    <i class="fas fa-check-circle good"></i>
                    <span>Acoustic sensors clear</span>
                </div>
            </div>
            
            <div class="last-scan-info">
                <p><i class="fas fa-clock"></i> Last comprehensive scan: {{ last_update }}</p>
                <p><i class="fas fa-shield-alt"></i> Next scheduled scan: 2 hours</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="leak-detection-settings">
        <h4><i class="fas fa-sliders-h"></i> Detection Settings</h4>
        
        <div class="settings-grid">
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" checked>
                    <span class="setting-text">Real-time Pressure Monitoring</span>
                </label>
                <span class="setting-status good">Active</span>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" checked>
                    <span class="setting-text">Acoustic Leak Detection</span>
                </label>
                <span class="setting-status good">Active</span>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" checked>
                    <span class="setting-text">Flow Analysis Algorithms</span>
                </label>
                <span class="setting-status good">Active</span>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox">
                    <span class="setting-text">Predictive Leak Analytics</span>
                </label>
                <span class="setting-status">Inactive</span>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" checked>
                    <span class="setting-text">Automatic Alerts</span>
                </label>
                <span class="setting-status good">Active</span>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox">
                    <span class="setting-text">Auto-isolation Protocol</span>
                </label>
                <span class="setting-status warning">Standby</span>
            </div>
        </div>
        
        <div class="sensitivity-control">
            <h5>Detection Sensitivity</h5>
            <div class="sensitivity-slider">
                <input type="range" min="1" max="10" value="7" class="slider" 
                       oninput="updateSensitivity(this.value)">
                <div class="sensitivity-labels">
                    <span>Low</span>
                    <span>Medium</span>
                    <span>High</span>
                </div>
            </div>
            <p class="sensitivity-note">Current: Medium-High (Recommended for balance of accuracy and false positives)</p>
        </div>
    </div>
    
    <div class="leak-prevention-tips">
        <h4><i class="fas fa-lightbulb"></i> Leak Prevention Tips</h4>
        <div class="tips-grid">
            <div class="tip-card">
                <div class="tip-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="tip-content">
                    <h5>Regular Maintenance</h5>
                    <p>Schedule pipe inspections every 6 months to catch potential issues early.</p>
                </div>
            </div>
            
            <div class="tip-card">
                <div class="tip-icon">
                    <i class="fas fa-thermometer-half"></i>
                </div>
                <div class="tip-content">
                    <h5>Temperature Monitoring</h5>
                    <p>Monitor for temperature fluctuations that can cause pipe stress.</p>
                </div>
            </div>
            
            <div class="tip-card">
                <div class="tip-icon">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
                <div class="tip-content">
                    <h5>Pressure Regulation</h5>
                    <p>Maintain optimal water pressure to reduce strain on pipes and joints.</p>
                </div>
            </div>
            
            <div class="tip-card">
                <div class="tip-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="tip-content">
                    <h5>Early Warning Systems</h5>
                    <p>Install water sensors in vulnerable areas for early leak detection.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.leak-detection-component {
    background: rgba(20, 30, 60, 0.9);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(64, 156, 255, 0.3);
}

.status-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.status-card {
    background: rgba(30, 40, 70, 0.8);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    border: 1px solid rgba(64, 156, 255, 0.2);
    transition: all 0.3s ease;
}

.status-card:hover {
    transform: translateY(-3px);
    border-color: rgba(64, 156, 255, 0.4);
}

.status-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.status-icon.critical {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
    border: 2px solid #f44336;
}

.status-icon.warning {
    background: rgba(255, 152, 0, 0.2);
    color: #ff9800;
    border: 2px solid #ff9800;
}

.status-icon.good {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    border: 2px solid #4caf50;
}

.status-icon.info {
    background: rgba(79, 195, 247, 0.2);
    color: #4fc3f7;
    border: 2px solid #4fc3f7;
}

.status-content h4 {
    color: #8ab4f8;
    margin: 0 0 5px 0;
    font-size: 14px;
}

.status-value {
    display: flex;
    align-items: baseline;
    gap: 5px;
}

.status-value .count {
    color: white;
    font-size: 28px;
    font-weight: 700;
    font-family: 'Orbitron', sans-serif;
}

.status-value .count.critical {
    color: #f44336;
}

.status-value .unit {
    color: #8ab4f8;
    font-size: 14px;
}

.active-leaks-alert {
    background: rgba(244, 67, 54, 0.1);
    border: 2px solid #f44336;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 25px;
}

.alert-header {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: rgba(244, 67, 54, 0.2);
}

.alert-header.critical {
    border-bottom: 1px solid rgba(244, 67, 54, 0.3);
}

.alert-header.good {
    background: rgba(76, 175, 80, 0.2);
    border-bottom: 1px solid rgba(76, 175, 80, 0.3);
}

.alert-icon {
    font-size: 24px;
}

.alert-header.critical .alert-icon {
    color: #f44336;
}

.alert-header.good .alert-icon {
    color: #4caf50;
}

.alert-content h4 {
    color: white;
    margin: 0 0 5px 0;
    font-family: 'Orbitron', sans-serif;
}

.alert-content p {
    color: #8ab4f8;
    margin: 0;
    font-size: 14px;
}

.alert-actions {
    margin-left: auto;
}

.leaks-list {
    padding: 20px;
}

.leak-item {
    background: rgba(30, 40, 70, 0.9);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    border-left: 4px solid #f44336;
}

.leak-item.critical {
    border-left-color: #f44336;
}

.leak-item.warning {
    border-left-color: #ff9800;
}

.leak-info {
    margin-bottom: 15px;
}

.leak-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.leak-icon {
    color: #f44336;
    font-size: 24px;
}

.leak-details h5 {
    color: white;
    margin: 0 0 5px 0;
    font-size: 16px;
}

.leak-severity {
    color: #f44336;
    margin: 0;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.leak-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.metric {
    background: rgba(40, 50, 80, 0.6);
    padding: 10px;
    border-radius: 6px;
}

.metric-label {
    color: #8ab4f8;
    font-size: 11px;
    display: block;
    margin-bottom: 5px;
}

.metric-value {
    color: white;
    font-weight: 600;
    font-size: 14px;
}

.metric-value.critical {
    color: #f44336;
}

.leak-location {
    background: rgba(40, 50, 80, 0.6);
    padding: 10px;
    border-radius: 6px;
}

.leak-location p {
    color: #8ab4f8;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
}

.leak-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.no-leaks-alert {
    background: rgba(76, 175, 80, 0.1);
    border: 2px solid #4caf50;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    margin-bottom: 25px;
}

.integrity-check {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 25px 0;
}

.check-item {
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    color: white;
    font-size: 14px;
}

.check-item i.good {
    color: #4caf50;
}

.last-scan-info {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(76, 175, 80, 0.3);
}

.last-scan-info p {
    color: #8ab4f8;
    margin: 5px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    font-size: 13px;
}

.leak-detection-settings {
    background: rgba(30, 40, 70, 0.8);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(64, 156, 255, 0.2);
}

.leak-detection-settings h4 {
    color: white;
    margin: 0 0 20px 0;
    font-family: 'Orbitron', sans-serif;
    display: flex;
    align-items: center;
    gap: 10px;
}

.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(40, 50, 80, 0.6);
    border-radius: 8px;
}

.setting-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    color: white;
    font-size: 14px;
}

.setting-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.setting-status {
    font-size: 12px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 12px;
}

.setting-status.good {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    border: 1px solid #4caf50;
}

.setting-status.warning {
    background: rgba(255, 152, 0, 0.2);
    color: #ff9800;
    border: 1px solid #ff9800;
}

.sensitivity-control {
    margin-top: 25px;
    padding-top: 25px;
    border-top: 1px solid rgba(64, 156, 255, 0.2);
}

.sensitivity-control h5 {
    color: white;
    margin: 0 0 15px 0;
    font-size: 16px;
}

.sensitivity-slider {
    margin-bottom: 10px;
}

.slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(64, 156, 255, 0.2);
    outline: none;
    -webkit-appearance: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #4fc3f7;
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
}

.sensitivity-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 5px;
    color: #8ab4f8;
    font-size: 12px;
}

.sensitivity-note {
    color: #8ab4f8;
    font-size: 13px;
    margin: 10px 0 0 0;
    font-style: italic;
}

.leak-prevention-tips {
    background: rgba(30, 40, 70, 0.8);
    border-radius: 12px;
    padding: 25px;
    border: 1px solid rgba(64, 156, 255, 0.2);
}

.leak-prevention-tips h4 {
    color: white;
    margin: 0 0 20px 0;
    font-family: 'Orbitron', sans-serif;
    display: flex;
    align-items: center;
    gap: 10px;
}

.tips-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.tip-card {
    background: rgba(40, 50, 80, 0.6);
    border-radius: 10px;
    padding: 20px;
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

.tip-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: rgba(79, 195, 247, 0.2);
    border: 1px solid rgba(79, 195, 247, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #4fc3f7;
    font-size: 18px;
    flex-shrink: 0;
}

.tip-content h5 {
    color: white;
    margin: 0 0 8px 0;
    font-size: 15px;
}

.tip-content p {
    color: #8ab4f8;
    margin: 0;
    font-size: 13px;
    line-height: 1.5;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .status-overview {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .tips-grid {
        grid-template-columns: 1fr;
    }
    
    .leak-metrics {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .status-overview {
        grid-template-columns: 1fr;
    }
    
    .settings-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Leak detection functions
function initiateLeakScan() {
    if (confirm('Initiate comprehensive leak scan?\n\nThis will analyze all sensors and may take 10-15 seconds.')) {
        showNotification('Starting leak detection scan...', 'info');
        
        // Show scanning animation
        const scanBtn = document.querySelector('.component-actions .primary');
        if (scanBtn) {
            const originalHtml = scanBtn.innerHTML;
            scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
            scanBtn.disabled = true;
            
            // Simulate scan duration
            setTimeout(() => {
                scanBtn.innerHTML = originalHtml;
                scanBtn.disabled = false;
                
                // Call the checkLeaks function from dashboard.js
                if (typeof checkLeaks === 'function') {
                    checkLeaks();
                } else {
                    showNotification('Leak scan complete. No active leaks detected.', 'success');
                }
            }, 3000);
        }
    }
}

function viewLeakHistory() {
    showNotification('Loading leak history...', 'info');
    
    // In a real app, this would fetch and display historical data
    setTimeout(() => {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-history"></i> Leak Detection History</h3>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="history-chart-container">
                        <canvas id="leakHistoryChart" width="400" height="200"></canvas>
                    </div>
                    
                    <div class="history-stats">
                        <div class="stat">
                            <span class="stat-label">Total Leaks (30 days):</span>
                            <span class="stat-value">18</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Avg Response Time:</span>
                            <span class="stat-value">14 minutes</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Water Saved:</span>
                            <span class="stat-value">12,450 liters</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Detection Accuracy:</span>
                            <span class="stat-value good">94.2%</span>
                        </div>
                    </div>
                    
                    <div class="recent-incidents">
                        <h4>Recent Incidents</h4>
                        <div class="incidents-list">
                            <div class="incident">
                                <span class="incident-date">Today, 14:30</span>
                                <span class="incident-location">Main Supply Line</span>
                                <span class="incident-severity resolved">Resolved</span>
                            </div>
                            <div class="incident">
                                <span class="incident-date">Yesterday, 09:15</span>
                                <span class="incident-location">Zone A - Branch Line 1</span>
                                <span class="incident-severity resolved">Resolved</span>
                            </div>
                            <div class="incident">
                                <span class="incident-date">3 days ago</span>
                                <span class="incident-location">Junction Supply Line</span>
                                <span class="incident-severity resolved">Resolved</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                        Close
                    </button>
                    <button class="btn btn-primary" onclick="exportLeakHistory()">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.style.display = 'flex';
        
        // Initialize chart
        setTimeout(initializeLeakHistoryChart, 100);
    }, 1000);
}

function initializeLeakHistoryChart() {
    const canvas = document.getElementById('leakHistoryChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Sample chart data
    const data = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Leak Incidents',
            data: [2, 3, 1, 4, 2, 1, 3],
            backgroundColor: 'rgba(244, 67, 54, 0.2)',
            borderColor: '#f44336',
            borderWidth: 2,
            tension: 0.4
        }]
    };
    
    new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#8ab4f8'
                    },
                    grid: {
                        color: 'rgba(64, 156, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#8ab4f8'
                    },
                    grid: {
                        color: 'rgba(64, 156, 255, 0.1)'
                    }
                }
            }
        }
    });
}

function exportLeakHistory() {
    showNotification('Exporting leak history report...', 'info');
    setTimeout(() => {
        showNotification('Leak history report exported successfully', 'success');
    }, 1500);
}

function emergencyProtocol() {
    if (confirm('ACTIVATE EMERGENCY PROTOCOL?\n\nThis will:\n1. Close all main valves\n2. Shut down affected zones\n3. Notify emergency teams\n4. Initiate backup systems\n\nConfirm emergency response?')) {
        showNotification('EMERGENCY PROTOCOL ACTIVATED!', 'error');
        
        // Show emergency progress
        const progressModal = document.createElement('div');
        progressModal.className = 'modal';
        progressModal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-siren-on"></i> Emergency Protocol</h3>
                </div>
                <div class="modal-body">
                    <div class="emergency-progress">
                        <div class="progress-step active">
                            <div class="step-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="step-content">
                                <h5>Alerting Teams</h5>
                                <p>Notifying maintenance and emergency response</p>
                            </div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">
                                <i class="fas fa-ban"></i>
                            </div>
                            <div class="step-content">
                                <h5>Isolating Sections</h5>
                                <p>Closing valves in affected areas</p>
                            </div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">
                                <i class="fas fa-power-off"></i>
                            </div>
                            <div class="step-content">
                                <h5>System Shutdown</h5>
                                <p>Initiating controlled shutdown</p>
                            </div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="step-content">
                                <h5>Safety Check</h5>
                                <p>Verifying all safety measures</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(progressModal);
        progressModal.style.display = 'flex';
        
        // Simulate emergency protocol steps
        const steps = progressModal.querySelectorAll('.progress-step');
        let currentStep = 0;
        
        const stepInterval = setInterval(() => {
            if (currentStep < steps.length) {
                steps[currentStep].classList.add('active');
                currentStep++;
            } else {
                clearInterval(stepInterval);
                setTimeout(() => {
                    progressModal.remove();
                    showNotification('Emergency protocol completed successfully', 'success');
                    if (typeof refreshDashboardData === 'function') {
                        refreshDashboardData();
                    }
                }, 1000);
            }
        }, 1500);
    }
}

function isolateSection(pipeName) {
    if (confirm(`Isolate ${pipeName}?\n\nThis will close all valves feeding this section and cut off water supply.`)) {
        showNotification(`Isolating ${pipeName}...`, 'warning');
        
        // In a real app, this would call an isolation API
        setTimeout(() => {
            showNotification(`${pipeName} isolated. Water flow stopped.`, 'success');
            if (typeof refreshDashboardData === 'function') {
                refreshDashboardData();
            }
        }, 2000);
    }
}

function dispatchTeam(pipeName) {
    showNotification(`Dispatching maintenance team to ${pipeName}...`, 'info');
    
    setTimeout(() => {
        showNotification(`Maintenance team dispatched. ETA: 25 minutes.`, 'success');
    }, 1000);
}

function leakDetails(pipeName) {
    // Create detailed leak information modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Leak Analysis: ${pipeName}</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="leak-analysis">
                    <div class="analysis-section">
                        <h4>Detection Details</h4>
                        <div class="details-grid">
                            <div class="detail">
                                <span class="detail-label">Detection Method:</span>
                                <span class="detail-value">Pressure Differential Analysis</span>
                            </div>
                            <div class="detail">
                                <span class="detail-label">Confidence Level:</span>
                                <span class="detail-value critical">98.7%</span>
                            </div>
                            <div class="detail">
                                <span class="detail-label">First Detected:</span>
                                <span class="detail-value">${new Date().toLocaleString()}</span>
                            </div>
                            <div class="detail">
                                <span class="detail-label">Estimated Size:</span>
                                <span class="detail-value">Medium (2-3mm)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>Impact Assessment</h4>
                        <div class="impact-metrics">
                            <div class="metric">
                                <div class="metric-value critical">2.5 L/min</div>
                                <div class="metric-label">Water Loss</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value warning">$45/day</div>
                                <div class="metric-label">Cost Impact</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">3 zones</div>
                                <div class="metric-label">Affected Areas</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>Recommended Actions</h4>
                        <ol class="action-list">
                            <li>Immediate isolation of section</li>
                            <li>Pressure testing of adjacent pipes</li>
                            <li>Replacement of damaged segment</li>
                            <li>Post-repair pressure verification</li>
                        </ol>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>Historical Data</h4>
                        <p>This section has had 2 previous leaks in the last 12 months.</p>
                        <p>Average repair time: 3.5 hours</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                    Close
                </button>
                <button class="btn btn-primary" onclick="createWorkOrder('${pipeName}'); this.closest('.modal').remove()">
                    <i class="fas fa-clipboard-check"></i> Create Work Order
                </button>
                <button class="btn btn-danger" onclick="isolateSection('${pipeName}'); this.closest('.modal').remove()">
                    <i class="fas fa-ban"></i> Isolate Now
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';
}

function createWorkOrder(pipeName) {
    showNotification(`Creating work order for ${pipeName}...`, 'info');
    setTimeout(() => {
        showNotification(`Work order #${Math.floor(Math.random() * 10000)} created for ${pipeName}`, 'success');
    }, 1500);
}

function updateSensitivity(value) {
    const sensitivityNote = document.querySelector('.sensitivity-note');
    if (sensitivityNote) {
        let level = 'Low';
        if (value > 3 && value <= 6) level = 'Medium';
        if (value > 6 && value <= 8) level = 'Medium-High';
        if (value > 8) level = 'High';
        
        sensitivityNote.textContent = `Current: ${level} (Recommended for balance of accuracy and false positives)`;
    }
    
    // In a real app, this would update the sensitivity setting via API
    console.log(`Detection sensitivity updated to: ${value}`);
}
</script>